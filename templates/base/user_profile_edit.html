{% extends "base/base.html" %}
{% load static %}
{% block content %}

{% if messages %}
<ul class="errorlist">
    {% for message in messages %}
    <button class="rounded btn btn-danger mx-auto d-flex">{{ message }}</button>
    {% endfor %}
</ul>
{% endif %}


<form method="post" novalidate class="w-50 mx-auto" action="{% url 'user_profile_edit_view' %}"
    enctype="multipart/form-data">
    {% csrf_token %}

<div class="text-center d-flex flex-column align-items-center justify-content-center">
    {% if request.user.profile_picture %}
    <img id="profile__p__edit" class="rounded-circle" src="{{ request.user.profile_picture.url }}" alt="">
    {% else %}
    <img id="profile__p__edit" class="rounded-circle" src="{% static 'base/images/default_pp.png' %}" alt="">
    {% endif %}
    <button type="button" id="changeProfileBtn" class="btn btn-sm btn-warning my-2">Change Profile</button>
    <h6 class="fst-italic my-4 btn btn-success rounded-pill">{{request.user.email}}</h6>

    <input type="file" id="profilePictureInput" style="display: none;" accept="image/*">
</div>


    <div class="row">
        <div class="col">


            <div class="form-floating mb-3">
                <input value="{{request.user.first_name}}" type="text" id="first_name" name="first_name"
                    class="form-control" placeholder="First Name">
                <label for="first_name">First Name</label>
            </div>


        </div>



        <div class="col">


            <div class="form-floating mb-3">
                <input value="{{request.user.last_name}}" type="text" id="last_name" name="last_name"
                    class="form-control" placeholder="First Name">
                <label for="last_name">Last Name</label>
            </div>

        </div>
    </div>

    <div class="form-floating mb-3">
        <input value="{{request.user.user_title}}" type="text" id="user_title" name="user_title" class="form-control"
            placeholder="Title">
        <label for="user_title">Title</label>
    </div>



    <div class="form-floating mb-3">
        <textarea type="text" id="user_bio" name="user_bio" class="form-control" placeholder="Bio"
            style="height: 200px;">{{request.user.user_bio}}</textarea>
        <label for="user_bio">Bio</label>
    </div>


    <div class="row">

        <div class="col">
            <div class="form-floating mb-3">
                <input value="{{request.user.facebook_link}}" type="text" onChange="validateUrl(this)"
                    id="facebook_link" name="facebook_link" class="form-control" placeholder="facebook Link">
                <label for="facebook_link">Facebook url</label>
            </div>
        </div>
        <div class="col">

            <div class="form-floating mb-3">
                <input value="{{request.user.twitter_link}}" type="text" onChange="validateUrl(this)" id="twitter_link"
                    name="twitter_link" class="form-control" placeholder="twitter Link">
                <label for="twitter_link">Twitter url</label>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="form-floating mb-3">
                <input value="{{request.user.linkedin_link}}" type="text" onChange="validateUrl(this)"
                    id="linkedin_link" name="linkedin_link" class="form-control" placeholder="linkedin Link">
                <label for="linkedin_link">Linkedin url</label>
            </div>
        </div>
        <div class="col">

            <div class="form-floating mb-3">
                <input value="{{request.user.instagram_link}}" type="text" onChange="validateUrl(this)"
                    id="instagram_link" name="instagram_link" class="form-control" placeholder="instagram Link">
                <label for="instagram_link">Instagram url</label>
            </div>
        </div>
    </div>




    <div class="specialty_tag my-4">
        <h1 class="fw-bold">Your Specialties</h1>
        <hr>
        <div class="all_specialty all_listing" id="all_specialty">

            {% for specialty in request.user.specialty.all %}
            <div class="single">
                <div class="form-floating mb-3">


                    <input value="{{specialty.title}}" type="text" id="specialty{{forloop.counter}}"
                        name="specialty{{forloop.counter}}" class="form-control"
                        placeholder="Specialty {{forloop.counter}}">

                    <label for="specialty{{forloop.counter}}">Specialty {{forloop.counter}}</label>

                </div>

                <div class="form-floating mb-3">
                    <textarea id="specialtydesc{{forloop.counter}}" name="specialtydesc{{forloop.counter}}"
                        class="form-control my-2" style="height: 200px;"
                        placeholder="Short Description">{{specialty.short_description}}</textarea>

                    <label for="specialtydesc{{forloop.counter}}">Short Description</label>
                </div>
            </div>
            {% endfor %}

        </div>

        <button onclick="addBtnClicked(this, 'spe')" class="mx-auto d-flex btn btn-sm btn-success" type="button">Add
            Specialty</button>

    </div>




    <div class="expertise_tag my-4">
        <h1 class="fw-bold">Your Expertise</h1>
        <hr>
        <div class="all_expertise all_listing" id="all_expertises">

        </div>

        <button onclick="addBtnClicked(this, 'exp')" class="mx-auto d-flex btn btn-sm btn-success" type="button">Add
            Expertise</button>

    </div>



    <div class="education_tag my-4">
        <h1 class="fw-bold">Your Education</h1>
        <hr>
        <div class="all_education all_listing" id="all_educations">

        </div>

        <button onclick="addBtnClicked(this, 'edu')" class="mx-auto d-flex btn btn-sm btn-success" type="button">Add
            Education</button>

    </div>



    <div class="affiliation_tag my-4">
        <h1 class="fw-bold">Your Affiliations</h1>
        <hr>
        <div class="all_affiliations all_listing" id="all_affiliations">

        </div>

        <button onclick="addBtnClicked(this, 'aff')" class="mx-auto d-flex btn btn-sm btn-success" type="button">Add
            Affiliation</button>
    </div>



    <div class="honourandaward_tag my-4">
        <h1 class="fw-bold">Your Honour and Awards</h1>
        <hr>
        <div class="all_honourandawards all_listing" id="all_honourandawards">

        </div>

        <button onclick="addBtnClicked(this, 'haa')" class="mx-auto d-flex btn btn-sm btn-success" type="button">Add
            Honour and Awards</button>
    </div>






    <button class="btn btn-primary" id="save__profile__change" type="submit">Save</button>
</form>
<script>


    document.addEventListener("DOMContentLoaded", function () {
        // Get necessary elements
        const profilePictureEdit = document.getElementById("profile__p__edit");
        const changeProfileBtn = document.getElementById("changeProfileBtn");
        const profilePictureInput = document.getElementById("profilePictureInput");

        // Add click event listener to the button
        changeProfileBtn.addEventListener("click", function () {
            // Trigger file input when the button is clicked
            profilePictureInput.click();
        });

        // Add change event listener to the file input
        profilePictureInput.addEventListener("change", function () {
            const file = this.files[0]; // Get the selected file

            if (file) {
                // If a file is selected, display it in the image tag
                const reader = new FileReader();

                reader.onload = function (e) {
                    profilePictureEdit.src = e.target.result;
                };

                reader.readAsDataURL(file);
            }
            // If no file is selected, do nothing and retain the previous image
        });
    });



    function validateUrl(element) {
        // Extract URL value from the input element
        var url = element.value;

        // Extract the ID of the element
        var elementId = element.id;

        var urlRegex = new RegExp(
            "^(https?:\\/\\/)?" + // protocol
            "((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|" + // domain name
            "((\\d{1,3}\\.){3}\\d{1,3}))" + // OR ip (v4) address
            "(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*" + // port and path
            "(\\?[;&a-z\\d%_.~+=-]*)?" + // query string
            "(\\#[-a-z\\d_]*)?$",
            "i",
            "|^$", // empty input
        );
        var isValid = url !== "" ? urlRegex.test(url) : true;
        if (!isValid) {

            var errorMessage = element.parentNode.querySelector('p');
            if (!errorMessage) {
                errorMessage = document.createElement('p');
            }

            errorMessage.className = 'invalid-feedback text-danger mx-2';
            errorMessage.innerText = 'URL is not valid.';
            element.parentNode.appendChild(errorMessage);

            save__profile__change.disabled = true;
        } else {
            // URL is valid, remove error message if exists
            var errorMessage = element.parentNode.querySelector('p');
            if (errorMessage) {
                element.parentNode.removeChild(errorMessage);
            };
            save__profile__change.disabled = false;
        }

        return isValid;
    }

    function createPacker(formDiv, formDivDesc, formIndex, name) {
        formDiv.innerHTML = createInputwithLabel(`${name.replace(/\s+/g, '').toLowerCase()}${formIndex}`, `form-control my-2`, `${name} ${formIndex}`);

        formDivDesc.innerHTML = createTextAreawithLabel(`${name.replace(/\s+/g, '').toLowerCase()}desc_${formIndex}`, `form-control my-2`, `Short Description`, `200px`);
    }

    function createTextAreawithLabel(id, className, placeholder, height) {
        var form = document.createElement("div")
        form.className = "form-floating mb-3"
        var label = document.createElement("label")
        label.setAttribute('for', id)
        label.innerText = placeholder

        var textarea = document.createElement("textarea");
        textarea.id = id;
        textarea.name = id;
        textarea.className = "form-control my-2";
        textarea.style.height = "200px";
        textarea.placeholder = "Short Description";
        textarea.value = "Initial value for the textarea";

        form.appendChild(textarea);
        form.appendChild(label);
        return form.innerHTML;
    }
    function createInputwithLabel(id, className, placeholder) {

        var form = document.createElement("div")
        form.className = "form-floating mb-3"
        var label = document.createElement("label")
        label.setAttribute('for', id)
        label.innerText = placeholder

        var input = document.createElement("input");
        input.id = id;
        input.name = id;
        input.className = "form-control my-2";
        input.placeholder = placeholder;

        form.appendChild(input);
        form.appendChild(label);
        return form.innerHTML;
    }

    function addBtnClicked(ele, what) {
        console.log(ele.parentNode.querySelectorAll('.all_listing>div').length)
        const formIndex = ele.parentNode.querySelectorAll('.all_listing>div').length + 1

        const formDiv = document.createElement('div');
        formDiv.className = 'form-floating mb-3';
        formDiv.id = `form_${formIndex}`;

        const formDivDesc = document.createElement('div');
        formDivDesc.className = 'form-floating mb-3';
        formDivDesc.id = `form_${formIndex}`;




        if (what == 'aff') {
            createPacker(formDiv, formDivDesc, formIndex, 'Affiliation')
        } else if (what == 'exp') {
            createPacker(formDiv, formDivDesc, formIndex, 'Expertise')
        } else if (what == 'edu') {
            createPacker(formDiv, formDivDesc, formIndex, 'Education')
        } else if (what == 'haa') {
            createPacker(formDiv, formDivDesc, formIndex, 'Honour and Awards')
        } else if (what == 'spe') {
            createPacker(formDiv, formDivDesc, formIndex, 'Specialty')
        }


        let single_div = document.createElement('div');
        single_div.className = 'single';
        single_div.appendChild(formDiv)
        single_div.appendChild(formDivDesc)

        ele.parentNode.querySelectorAll('.all_listing')[0].appendChild(single_div)

    }
</script>
{% endblock content %}